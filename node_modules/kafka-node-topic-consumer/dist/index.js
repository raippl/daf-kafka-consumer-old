'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _sourceMapSupport = require('source-map-support');

var _sourceMapSupport2 = _interopRequireDefault(_sourceMapSupport);

var _async = require('async');

var _async2 = _interopRequireDefault(_async);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _events = require('events');

var _events2 = _interopRequireDefault(_events);

var _fastq = require('fastq');

var _fastq2 = _interopRequireDefault(_fastq);

var _joi = require('joi');

var _joi2 = _interopRequireDefault(_joi);

var _kafkaNode = require('kafka-node');

var _kafkaNode2 = _interopRequireDefault(_kafkaNode);

var _ms = require('ms');

var _ms2 = _interopRequireDefault(_ms);

var _retry = require('retry');

var _retry2 = _interopRequireDefault(_retry);

var _lodash = require('lodash');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

_sourceMapSupport2.default.install();

var Client = _kafkaNode2.default.Client,
    HighLevelConsumer = _kafkaNode2.default.HighLevelConsumer;

var TopicConsumer = function (_EventEmitter) {
  _inherits(TopicConsumer, _EventEmitter);

  function TopicConsumer(options) {
    _classCallCheck(this, TopicConsumer);

    // validate options
    var _this = _possibleConstructorReturn(this, (TopicConsumer.__proto__ || Object.getPrototypeOf(TopicConsumer)).call(this));

    var optionsSchema = _joi2.default.object({
      concurrency: _joi2.default.number().integer().min(1).default(1),
      consumer: _joi2.default.object({
        groupId: _joi2.default.string().required()
      }).required(),
      host: _joi2.default.string(),
      parse: _joi2.default.func(),
      rebuild: _joi2.default.object({
        closing: _joi2.default.object({}).description('valid node-retry options'),
        minDelay: _joi2.default.alternatives().try(_joi2.default.string(), _joi2.default.number().integer().min(0)),
        maxDelay: _joi2.default.alternatives().try(_joi2.default.string(), _joi2.default.number().integer().min(0))
      }).default({ minDelay: '35s', maxDelay: '2m' }),
      topic: _joi2.default.alternatives().try(_joi2.default.string(), _joi2.default.object({
        topic: _joi2.default.string()
      })).required(),
      validate: _joi2.default.func().arity(1)
    }).or('host', 'client').unknown(true).required();

    _this.options = _joi2.default.attempt(options, optionsSchema);
    var _this$options = _this.options,
        concurrency = _this$options.concurrency,
        consumerOptions = _this$options.consumer,
        topic = _this$options.topic;

    _this.parse = _this.options.parse;
    _this.validate = _this.options.validate;
    _this._fetchPayloads = (0, _lodash.isObject)(topic) ? [topic] : [{ topic: topic }];
    _this._consumerOptions = (0, _lodash.defaults)(consumerOptions, {
      autoCommit: false,
      paused: true
    });
    _this.workers = [];

    _this._configureConsumer();
    _this._configureQueue(concurrency);
    return _this;
  }

  /**
   * Configure consumer event handlers
   * @return  {Undefined} undefined
   * @private
   */


  _createClass(TopicConsumer, [{
    key: '_configureConsumer',
    value: function _configureConsumer() {
      var _this2 = this;

      delete this.client;
      delete this.consumer;

      var host = this.options.host;

      this.client = this.options.client || new Client(host);
      this.consumer = new HighLevelConsumer(this.client, this._fetchPayloads, this._consumerOptions);

      this.consumer.on('message', this.processMessage.bind(this));

      this.consumer.on('error', function (err) {
        _this2.emit('consumer:error', err);
        _this2.consumer.pause();
        _this2._rebuildConsumer();
      });

      this.consumer.on('offsetOutOfRange', function () {
        _this2.emit('consumer:offset-out-of-range');
      });
    }

    /**
     * Build the queue instance for this consumer
     * @param  {Number} concurrency - queue concurrency
     * @return  {Undefined} undefined
     * @private
     */

  }, {
    key: '_configureQueue',
    value: function _configureQueue() {
      var concurrency = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 1;

      this.queue = (0, _fastq2.default)(this._processTask.bind(this), concurrency);
      this.queue.drain = this._onQueueDrained.bind(this);
    }

    /**
     * Expose a connect method for waiting until underlying consumer has
     * reached a 'ready' state
     * @param  {Function} done - callback
     * @return  {Bluebird} bluebird
     */

  }, {
    key: 'connect',
    value: function connect() {
      var _this3 = this;

      var done = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : _lodash.noop;

      this.emit('consumer:connecting');
      return new _bluebird2.default(function (resolve, reject) {
        var cleanup = function cleanup(err) {
          _this3.consumer.removeListener('registered', cleanup);
          _this3.consumer.removeListener('error', cleanup);
          if (err) {
            return reject(err);
          }
          _this3.emit('consumer:connected');
          return resolve();
        };
        _this3.consumer.on('registered', cleanup.bind(cleanup, null));
        _this3.consumer.on('error', cleanup);
      }).then(function () {
        _this3.emit('consumer:starting');
        _this3.consumer.resume();
        done();
      }).catch(function (err) {
        _this3.emit('consumer:error', err);
        _this3._rebuildConsumer(done);
      });
    }

    /**
     * Return detailed status Object
     * @return  {Object} status
     */

  }, {
    key: 'getStatus',
    value: function getStatus() {
      var _this4 = this;

      var defaultValues = {
        initialized: false,
        ready: false,
        closing: false,
        paused: false,
        rebalancing: false,
        topicPayloads: []
      };
      var consumer = (0, _lodash.reduce)(defaultValues, function (memo, val, attr) {
        var result = (0, _lodash.merge)({}, memo, _defineProperty({}, attr, (0, _lodash.get)(_this4, 'consumer.' + attr, val)));
        return result;
      }, {
        groupId: (0, _lodash.get)(this, 'consumer.options.groupId')
      });
      return {
        consumer: consumer,
        queue: {
          idle: this.queue.idle(),
          length: this.queue.length(),
          paused: this.queue.paused
        },
        status: consumer.ready && !consumer.closing && !this.queue.paused ? 'up' : 'down'
      };
    }

    /**
     * Handle queue drain event. Commit offsets and resume consuming messages.
     * @return  {Undefined} undefined
     * @private
     */

  }, {
    key: '_onQueueDrained',
    value: function _onQueueDrained() {
      var _this5 = this;

      this.consumer.commit(true, function (err) {
        if (err) {
          _this5.emit('consumer:commit-error', err);
        }
        _this5.emit('consumer:resuming');
        _this5.consumer.resume();
      });
    }

    /**
     * Parse a raw kafak message and append a new 'parsedValue' attribute
     * @param  {Object} raw - the raw kafka message emitted by the driver
     * @return  {Bluebird} bluebird
     */

  }, {
    key: 'processMessage',


    /**
     * Process a single message. Parse it and add it to the queue.
     * @param  {Object} raw - raw message
     * @return  {Undefined} undefined
     */
    value: function processMessage(raw) {
      var _this6 = this;

      // pause kafka consumer on first message
      if (!this.consumer.paused) {
        this.emit('consumer:pausing');
        this.consumer.pause();
      }
      // parse message and add it to queue
      var parseMessage = this.parse ? this.parse.bind(this) : TopicConsumer.parseMessage;
      parseMessage(raw).then(function (parsed) {
        _this6.queue.push(parsed, function (err) {
          if (err) {
            _this6.error = err;
            _this6.queue.kill();
          }
        });
      });
    }

    /**
     * Queue worker. Validate the parsed message, ignore it if invalid, otherwise
     * pass to all registered workers and pass if at least one resolves
     * @param  {Object} task - queue task
     * @param  {Function} done - callback
     * @return  {Bluebird} bluebird
     * @private
     */

  }, {
    key: '_processTask',
    value: function _processTask(task, done) {
      var _this7 = this;

      var validate = this.validate || _bluebird2.default.resolve;
      this.emit('message:processing', task);
      return validate(task).reflect().then(function (inspection) {
        if (inspection.isRejected()) {
          _this7.emit('message:skipped', task, inspection.reason());
          return _bluebird2.default.resolve();
        }
        var validated = inspection.value() || task;
        return _bluebird2.default.all(_this7.workers.map(function (worker) {
          return worker(validated);
        }));
      }).then(function (results) {
        _this7.emit('message:success', task, results);
        done();
      }).catch(function (err) {
        _this7.emit('message:error', err, task);
        done(err);
      });
    }

    /**
     * Rebuild the underlying consumer
     * @param  {Function} done - callback
     * @return  {Bluebird} bluebird
     * @private
     */

  }, {
    key: '_rebuildConsumer',
    value: function _rebuildConsumer(done) {
      var _this8 = this;

      this.emit('consumer:rebuild-initiated');
      _async2.default.series([
      // attempt to close existing consumer
      function (next) {
        if (!_this8.consumer) {
          return next();
        }
        var retryOptions = (0, _lodash.get)(_this8.options, 'rebuild.closing', {});
        (0, _lodash.defaults)(retryOptions, {
          retries: 2,
          minTimeout: (0, _ms2.default)('30s'),
          factor: 2
        });
        var operation = _retry2.default.operation(retryOptions);
        return operation.attempt(function () {
          _this8.consumer.close(true, function (err) {
            if (operation.retry(err)) {
              return;
            }
            if (err) {
              _this8.emit('consumer:closing-error', err);
            }
            next();
          });
        });
      },

      // schedule a rebuild in the near future
      function (next) {
        var delays = {
          min: (0, _lodash.get)(_this8.options, 'rebuild.minDelay'),
          max: (0, _lodash.get)(_this8.options, 'rebuild.maxDelay')
        };
        Object.keys(delays).forEach(function (delay) {
          if ((0, _lodash.isString)(delays[delay])) {
            delays[delay] = (0, _ms2.default)(delays[delay]);
          }
        });
        var delay = (0, _lodash.random)(delays.min, delays.max);
        _this8.emit('consumer:rebuild-scheduled', delay);
        setTimeout(function () {
          _this8.emit('consumer:rebuild-started');
          _this8._configureConsumer();
          _this8.connect(next);
        }, delay);
      }], done);
    }

    /**
     * Register a new worker function. Each worker function should be of the form
     * (parsedValue, log) => Bluebird
     * @param  {Function} worker - valid worker function
     * @return  {Undefined} undefined
     */

  }, {
    key: 'registerWorker',
    value: function registerWorker(worker) {
      _joi2.default.assert(worker, _joi2.default.func(2).required());
      this.workers.push(worker);
    }
  }], [{
    key: 'parseMessage',
    value: function parseMessage(raw) {
      return _bluebird2.default.try(function () {
        var parsed = (0, _lodash.merge)({}, raw, {
          parsedValue: JSON.parse(raw.value.toString('utf8'))
        });
        return parsed;
      });
    }
  }]);

  return TopicConsumer;
}(_events2.default);

exports.default = TopicConsumer;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2xpYi9pbmRleC5qcyJdLCJuYW1lcyI6WyJpbnN0YWxsIiwiQ2xpZW50IiwiSGlnaExldmVsQ29uc3VtZXIiLCJUb3BpY0NvbnN1bWVyIiwib3B0aW9ucyIsIm9wdGlvbnNTY2hlbWEiLCJvYmplY3QiLCJjb25jdXJyZW5jeSIsIm51bWJlciIsImludGVnZXIiLCJtaW4iLCJkZWZhdWx0IiwiY29uc3VtZXIiLCJncm91cElkIiwic3RyaW5nIiwicmVxdWlyZWQiLCJob3N0IiwicGFyc2UiLCJmdW5jIiwicmVidWlsZCIsImNsb3NpbmciLCJkZXNjcmlwdGlvbiIsIm1pbkRlbGF5IiwiYWx0ZXJuYXRpdmVzIiwidHJ5IiwibWF4RGVsYXkiLCJ0b3BpYyIsInZhbGlkYXRlIiwiYXJpdHkiLCJvciIsInVua25vd24iLCJhdHRlbXB0IiwiY29uc3VtZXJPcHRpb25zIiwiX2ZldGNoUGF5bG9hZHMiLCJfY29uc3VtZXJPcHRpb25zIiwiYXV0b0NvbW1pdCIsInBhdXNlZCIsIndvcmtlcnMiLCJfY29uZmlndXJlQ29uc3VtZXIiLCJfY29uZmlndXJlUXVldWUiLCJjbGllbnQiLCJvbiIsInByb2Nlc3NNZXNzYWdlIiwiYmluZCIsImVyciIsImVtaXQiLCJwYXVzZSIsIl9yZWJ1aWxkQ29uc3VtZXIiLCJxdWV1ZSIsIl9wcm9jZXNzVGFzayIsImRyYWluIiwiX29uUXVldWVEcmFpbmVkIiwiZG9uZSIsInJlc29sdmUiLCJyZWplY3QiLCJjbGVhbnVwIiwicmVtb3ZlTGlzdGVuZXIiLCJ0aGVuIiwicmVzdW1lIiwiY2F0Y2giLCJkZWZhdWx0VmFsdWVzIiwiaW5pdGlhbGl6ZWQiLCJyZWFkeSIsInJlYmFsYW5jaW5nIiwidG9waWNQYXlsb2FkcyIsIm1lbW8iLCJ2YWwiLCJhdHRyIiwicmVzdWx0IiwiaWRsZSIsImxlbmd0aCIsInN0YXR1cyIsImNvbW1pdCIsInJhdyIsInBhcnNlTWVzc2FnZSIsInBhcnNlZCIsInB1c2giLCJlcnJvciIsImtpbGwiLCJ0YXNrIiwicmVmbGVjdCIsImluc3BlY3Rpb24iLCJpc1JlamVjdGVkIiwicmVhc29uIiwidmFsaWRhdGVkIiwidmFsdWUiLCJhbGwiLCJtYXAiLCJ3b3JrZXIiLCJyZXN1bHRzIiwic2VyaWVzIiwibmV4dCIsInJldHJ5T3B0aW9ucyIsInJldHJpZXMiLCJtaW5UaW1lb3V0IiwiZmFjdG9yIiwib3BlcmF0aW9uIiwiY2xvc2UiLCJyZXRyeSIsImRlbGF5cyIsIm1heCIsIk9iamVjdCIsImtleXMiLCJmb3JFYWNoIiwiZGVsYXkiLCJzZXRUaW1lb3V0IiwiY29ubmVjdCIsImFzc2VydCIsInBhcnNlZFZhbHVlIiwiSlNPTiIsInRvU3RyaW5nIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7Ozs7Ozs7Ozs7QUFXQSwyQkFBV0EsT0FBWDs7SUFFUUMsTSx1QkFBQUEsTTtJQUFRQyxpQix1QkFBQUEsaUI7O0lBRUtDLGE7OztBQUNuQix5QkFBWUMsT0FBWixFQUFxQjtBQUFBOztBQUVuQjtBQUZtQjs7QUFHbkIsUUFBTUMsZ0JBQWdCLGNBQUlDLE1BQUosQ0FBVztBQUMvQkMsbUJBQWEsY0FBSUMsTUFBSixHQUFhQyxPQUFiLEdBQXVCQyxHQUF2QixDQUEyQixDQUEzQixFQUE4QkMsT0FBOUIsQ0FBc0MsQ0FBdEMsQ0FEa0I7QUFFL0JDLGdCQUFVLGNBQUlOLE1BQUosQ0FBVztBQUNuQk8saUJBQVMsY0FBSUMsTUFBSixHQUFhQyxRQUFiO0FBRFUsT0FBWCxFQUVQQSxRQUZPLEVBRnFCO0FBSy9CQyxZQUFNLGNBQUlGLE1BQUosRUFMeUI7QUFNL0JHLGFBQU8sY0FBSUMsSUFBSixFQU53QjtBQU8vQkMsZUFBUyxjQUFJYixNQUFKLENBQVc7QUFDbEJjLGlCQUFTLGNBQUlkLE1BQUosQ0FBVyxFQUFYLEVBQWVlLFdBQWYsQ0FBMkIsMEJBQTNCLENBRFM7QUFFbEJDLGtCQUFVLGNB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QUFULENBQWEsWUFBTTtBQUN4QixZQUFNbUQsU0FBUyxtQkFBTSxFQUFOLEVBQVVGLEdBQVYsRUFBZTtBQUM1Qm1DLHVCQUFhQyxLQUFLNUYsS0FBTCxDQUFXd0QsSUFBSVksS0FBSixDQUFVeUIsUUFBVixDQUFtQixNQUFuQixDQUFYO0FBRGUsU0FBZixDQUFmO0FBR0EsZUFBT25DLE1BQVA7QUFDRCxPQUxNLENBQVA7QUFNRDs7Ozs7O2tCQWpMa0J4RSxhIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHNvdXJjZW1hcHMgZnJvbSAnc291cmNlLW1hcC1zdXBwb3J0JztcbmltcG9ydCBhc3luYyBmcm9tICdhc3luYyc7XG5pbXBvcnQgQmx1ZWJpcmQgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IEV2ZW50RW1pdHRlciBmcm9tICdldmVudHMnO1xuaW1wb3J0IGZhc3RxIGZyb20gJ2Zhc3RxJztcbmltcG9ydCBqb2kgZnJvbSAnam9pJztcbmltcG9ydCBrYWZrYSBmcm9tICdrYWZrYS1ub2RlJztcbmltcG9ydCBtcyBmcm9tICdtcyc7XG5pbXBvcnQgcmV0cnkgZnJvbSAncmV0cnknO1xuaW1wb3J0IHtcbiAgZGVmYXVsdHMsXG4gIGdldCxcbiAgaXNPYmplY3QsXG4gIGlzU3RyaW5nLFxuICBtZXJnZSxcbiAgbm9vcCxcbiAgcmFuZG9tLFxuICByZWR1Y2UsXG59IGZyb20gJ2xvZGFzaCc7XG5cbnNvdXJjZW1hcHMuaW5zdGFsbCgpO1xuXG5jb25zdCB7IENsaWVudCwgSGlnaExldmVsQ29uc3VtZXIgfSA9IGthZmthO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBUb3BpY0NvbnN1bWVyIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcbiAgY29uc3RydWN0b3Iob3B0aW9ucykge1xuICAgIHN1cGVyKCk7XG4gICAgLy8gdmFsaWRhdGUgb3B0aW9uc1xuICAgIGNvbnN0IG9wdGlvbnNTY2hlbWEgPSBqb2kub2JqZWN0KHtcbiAgICAgIGNvbmN1cnJlbmN5OiBqb2kubnVtYmVyKCkuaW50ZWdlcigpLm1pbigxKS5kZWZhdWx0KDEpLFxuICAgICAgY29uc3VtZXI6IGpvaS5vYmplY3Qoe1xuICAgICAgICBncm91cElkOiBqb2kuc3RyaW5nKCkucmVxdWlyZWQoKSxcbiAgICAgIH0pLnJlcXVpcmVkKCksXG4gICAgICBob3N0OiBqb2kuc3RyaW5nKCksXG4gICAgICBwYXJzZTogam9pLmZ1bmMoKSxcbiAgICAgIHJlYnVpbGQ6IGpvaS5vYmplY3Qoe1xuICAgICAgICBjbG9zaW5nOiBqb2kub2JqZWN0KHt9KS5kZXNjcmlwdGlvbigndmFsaWQgbm9kZS1yZXRyeSBvcHRpb25zJyksXG4gICAgICAgIG1pbkRlbGF5OiBqb2kuYWx0ZXJuYXRpdmVzKCkudHJ5KFxuICAgICAgICAgIGpvaS5zdHJpbmcoKSxcbiAgICAgICAgICBqb2kubnVtYmVyKCkuaW50ZWdlcigpLm1pbigwKVxuICAgICAgICApLFxuICAgICAgICBtYXhEZWxheTogam9pLmFsdGVybmF0aXZlcygpLnRyeShcbiAgICAgICAgICBqb2kuc3RyaW5nKCksXG4gICAgICAgICAgam9pLm51bWJlcigpLmludGVnZXIoKS5taW4oMClcbiAgICAgICAgKSxcbiAgICAgIH0pLmRlZmF1bHQoeyBtaW5EZWxheTogJzM1cycsIG1heERlbGF5OiAnMm0nIH0pLFxuICAgICAgdG9waWM6IGpvaS5hbHRlcm5hdGl2ZXMoKS50cnkoXG4gICAgICAgIGpvaS5zdHJpbmcoKSxcbiAgICAgICAgam9pLm9iamVjdCh7XG4gICAgICAgICAgdG9waWM6IGpvaS5zdHJpbmcoKSxcbiAgICAgICAgfSlcbiAgICAgICkucmVxdWlyZWQoKSxcbiAgICAgIHZhbGlkYXRlOiBqb2kuZnVuYygpLmFyaXR5KDEpLFxuICAgIH0pXG4gICAgLm9yKCdob3N0JywgJ2NsaWVudCcpXG4gICAgLnVua25vd24odHJ1ZSlcbiAgICAucmVxdWlyZWQoKTtcblxuICAgIHRoaXMub3B0aW9ucyA9IGpvaS5hdHRlbXB0KG9wdGlvbnMsIG9wdGlvbnNTY2hlbWEpO1xuICAgIGNvbnN0IHsgY29uY3VycmVuY3ksIGNvbnN1bWVyOiBjb25zdW1lck9wdGlvbnMsIHRvcGljIH0gPSB0aGlzLm9wdGlvbnM7XG4gICAgdGhpcy5wYXJzZSA9IHRoaXMub3B0aW9ucy5wYXJzZTtcbiAgICB0aGlzLnZhbGlkYXRlID0gdGhpcy5vcHRpb25zLnZhbGlkYXRlO1xuICAgIHRoaXMuX2ZldGNoUGF5bG9hZHMgPSBpc09iamVjdCh0b3BpYykgPyBbdG9waWNdIDogW3sgdG9waWMgfV07XG4gICAgdGhpcy5fY29uc3VtZXJPcHRpb25zID0gZGVmYXVsdHMoY29uc3VtZXJPcHRpb25zLCB7XG4gICAgICBhdXRvQ29tbWl0OiBmYWxzZSxcbiAgICAgIHBhdXNlZDogdHJ1ZSxcbiAgICB9KTtcbiAgICB0aGlzLndvcmtlcnMgPSBbXTtcblxuICAgIHRoaXMuX2NvbmZpZ3VyZUNvbnN1bWVyKCk7XG4gICAgdGhpcy5fY29uZmlndXJlUXVldWUoY29uY3VycmVuY3kpO1xuICB9XG5cbiAgLyoqXG4gICAqIENvbmZpZ3VyZSBjb25zdW1lciBldmVudCBoYW5kbGVyc1xuICAgKiBAcmV0dXJuICB7VW5kZWZpbmVkfSB1bmRlZmluZWRcbiAgICogQHByaXZhdGVcbiAgICovXG4gIF9jb25maWd1cmVDb25zdW1lcigpIHtcbiAgICBkZWxldGUgdGhpcy5jbGllbnQ7XG4gICAgZGVsZXRlIHRoaXMuY29uc3VtZXI7XG5cbiAgICBjb25zdCB7IGhvc3QgfSA9IHRoaXMub3B0aW9ucztcbiAgICB0aGlzLmNsaWVudCA9IHRoaXMub3B0aW9ucy5jbGllbnQgfHwgbmV3IENsaWVudChob3N0KTtcbiAgICB0aGlzLmNvbnN1bWVyID0gbmV3IEhpZ2hMZXZlbENvbnN1bWVyKHRoaXMuY2xpZW50LCB0aGlzLl9mZXRjaFBheWxvYWRzLCB0aGlzLl9jb25zdW1lck9wdGlvbnMpO1xuXG4gICAgdGhpcy5jb25zdW1lci5vbignbWVzc2FnZScsIHRoaXMucHJvY2Vzc01lc3NhZ2UuYmluZCh0aGlzKSk7XG5cbiAgICB0aGlzLmNvbnN1bWVyLm9uKCdlcnJvcicsIChlcnIpID0+IHtcbiAgICAgIHRoaXMuZW1pdCgnY29uc3VtZXI6ZXJyb3InLCBlcnIpO1xuICAgICAgdGhpcy5jb25zdW1lci5wYXVzZSgpO1xuICAgICAgdGhpcy5fcmVidWlsZENvbnN1bWVyKCk7XG4gICAgfSk7XG5cbiAgICB0aGlzLmNvbnN1bWVyLm9uKCdvZmZzZXRPdXRPZlJhbmdlJywgKCkgPT4ge1xuICAgICAgdGhpcy5lbWl0KCdjb25zdW1lcjpvZmZzZXQtb3V0LW9mLXJhbmdlJyk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQnVpbGQgdGhlIHF1ZXVlIGluc3RhbmNlIGZvciB0aGlzIGNvbnN1bWVyXG4gICAqIEBwYXJhbSAge051bWJlcn0gY29uY3VycmVuY3kgLSBxdWV1ZSBjb25jdXJyZW5jeVxuICAgKiBAcmV0dXJuICB7VW5kZWZpbmVkfSB1bmRlZmluZWRcbiAgICogQHByaXZhdGVcbiAgICovXG4gIF9jb25maWd1cmVRdWV1ZShjb25jdXJyZW5jeSA9IDEpIHtcbiAgICB0aGlzLnF1ZXVlID0gZmFzdHEodGhpcy5fcHJvY2Vzc1Rhc2suYmluZCh0aGlzKSwgY29uY3VycmVuY3kpO1xuICAgIHRoaXMucXVldWUuZHJhaW4gPSB0aGlzLl9vblF1ZXVlRHJhaW5lZC5iaW5kKHRoaXMpO1xuICB9XG5cbiAgLyoqXG4gICAqIEV4cG9zZSBhIGNvbm5lY3QgbWV0aG9kIGZvciB3YWl0aW5nIHVudGlsIHVuZGVybHlpbmcgY29uc3VtZXIgaGFzXG4gICAqIHJlYWNoZWQgYSAncmVhZHknIHN0YXRlXG4gICAqIEBwYXJhbSAge0Z1bmN0aW9ufSBkb25lIC0gY2FsbGJhY2tcbiAgICogQHJldHVybiAge0JsdWViaXJkfSBibHVlYmlyZFxuICAgKi9cbiAgY29ubmVjdChkb25lID0gbm9vcCkge1xuICAgIHRoaXMuZW1pdCgnY29uc3VtZXI6Y29ubmVjdGluZycpO1xuICAgIHJldHVybiBuZXcgQmx1ZWJpcmQoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgY29uc3QgY2xlYW51cCA9IChlcnIpID0+IHtcbiAgICAgICAgdGhpcy5jb25zdW1lci5yZW1vdmVMaXN0ZW5lcigncmVnaXN0ZXJlZCcsIGNsZWFudXApO1xuICAgICAgICB0aGlzLmNvbnN1bWVyLnJlbW92ZUxpc3RlbmVyKCdlcnJvcicsIGNsZWFudXApO1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgcmV0dXJuIHJlamVjdChlcnIpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuZW1pdCgnY29uc3VtZXI6Y29ubmVjdGVkJyk7XG4gICAgICAgIHJldHVybiByZXNvbHZlKCk7XG4gICAgICB9O1xuICAgICAgdGhpcy5jb25zdW1lci5vbigncmVnaXN0ZXJlZCcsIGNsZWFudXAuYmluZChjbGVhbnVwLCBudWxsKSk7XG4gICAgICB0aGlzLmNvbnN1bWVyLm9uKCdlcnJvcicsIGNsZWFudXApO1xuICAgIH0pXG4gICAgLnRoZW4oKCkgPT4ge1xuICAgICAgdGhpcy5lbWl0KCdjb25zdW1lcjpzdGFydGluZycpO1xuICAgICAgdGhpcy5jb25zdW1lci5yZXN1bWUoKTtcbiAgICAgIGRvbmUoKTtcbiAgICB9KVxuICAgIC5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICB0aGlzLmVtaXQoJ2NvbnN1bWVyOmVycm9yJywgZXJyKTtcbiAgICAgIHRoaXMuX3JlYnVpbGRDb25zdW1lcihkb25lKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm4gZGV0YWlsZWQgc3RhdHVzIE9iamVjdFxuICAgKiBAcmV0dXJuICB7T2JqZWN0fSBzdGF0dXNcbiAgICovXG4gIGdldFN0YXR1cygpIHtcbiAgICBjb25zdCBkZWZhdWx0VmFsdWVzID0ge1xuICAgICAgaW5pdGlhbGl6ZWQ6IGZhbHNlLFxuICAgICAgcmVhZHk6IGZhbHNlLFxuICAgICAgY2xvc2luZzogZmFsc2UsXG4gICAgICBwYXVzZWQ6IGZhbHNlLFxuICAgICAgcmViYWxhbmNpbmc6IGZhbHNlLFxuICAgICAgdG9waWNQYXlsb2FkczogW10sXG4gICAgfTtcbiAgICBjb25zdCBjb25zdW1lciA9IHJlZHVjZShkZWZhdWx0VmFsdWVzLCAobWVtbywgdmFsLCBhdHRyKSA9PiB7XG4gICAgICBjb25zdCByZXN1bHQgPSBtZXJnZSh7fSwgbWVtbywge1xuICAgICAgICBbYXR0cl06IGdldCh0aGlzLCBgY29uc3VtZXIuJHthdHRyfWAsIHZhbCksXG4gICAgICB9KTtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSwge1xuICAgICAgZ3JvdXBJZDogZ2V0KHRoaXMsICdjb25zdW1lci5vcHRpb25zLmdyb3VwSWQnKSxcbiAgICB9KTtcbiAgICByZXR1cm4ge1xuICAgICAgY29uc3VtZXIsXG4gICAgICBxdWV1ZToge1xuICAgICAgICBpZGxlOiB0aGlzLnF1ZXVlLmlkbGUoKSxcbiAgICAgICAgbGVuZ3RoOiB0aGlzLnF1ZXVlLmxlbmd0aCgpLFxuICAgICAgICBwYXVzZWQ6IHRoaXMucXVldWUucGF1c2VkLFxuICAgICAgfSxcbiAgICAgIHN0YXR1czogY29uc3VtZXIucmVhZHkgJiYgIWNvbnN1bWVyLmNsb3NpbmcgJiYgIXRoaXMucXVldWUucGF1c2VkID8gJ3VwJyA6ICdkb3duJyxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEhhbmRsZSBxdWV1ZSBkcmFpbiBldmVudC4gQ29tbWl0IG9mZnNldHMgYW5kIHJlc3VtZSBjb25zdW1pbmcgbWVzc2FnZXMuXG4gICAqIEByZXR1cm4gIHtVbmRlZmluZWR9IHVuZGVmaW5lZFxuICAgKiBAcHJpdmF0ZVxuICAgKi9cbiAgX29uUXVldWVEcmFpbmVkKCkge1xuICAgIHRoaXMuY29uc3VtZXIuY29tbWl0KHRydWUsIChlcnIpID0+IHtcbiAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgdGhpcy5lbWl0KCdjb25zdW1lcjpjb21taXQtZXJyb3InLCBlcnIpO1xuICAgICAgfVxuICAgICAgdGhpcy5lbWl0KCdjb25zdW1lcjpyZXN1bWluZycpO1xuICAgICAgdGhpcy5jb25zdW1lci5yZXN1bWUoKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQYXJzZSBhIHJhdyBrYWZhayBtZXNzYWdlIGFuZCBhcHBlbmQgYSBuZXcgJ3BhcnNlZFZhbHVlJyBhdHRyaWJ1dGVcbiAgICogQHBhcmFtICB7T2JqZWN0fSByYXcgLSB0aGUgcmF3IGthZmthIG1lc3NhZ2UgZW1pdHRlZCBieSB0aGUgZHJpdmVyXG4gICAqIEByZXR1cm4gIHtCbHVlYmlyZH0gYmx1ZWJpcmRcbiAgICovXG4gIHN0YXRpYyBwYXJzZU1lc3NhZ2UocmF3KSB7XG4gICAgcmV0dXJuIEJsdWViaXJkLnRyeSgoKSA9PiB7XG4gICAgICBjb25zdCBwYXJzZWQgPSBtZXJnZSh7fSwgcmF3LCB7XG4gICAgICAgIHBhcnNlZFZhbHVlOiBKU09OLnBhcnNlKHJhdy52YWx1ZS50b1N0cmluZygndXRmOCcpKSxcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIHBhcnNlZDtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQcm9jZXNzIGEgc2luZ2xlIG1lc3NhZ2UuIFBhcnNlIGl0IGFuZCBhZGQgaXQgdG8gdGhlIHF1ZXVlLlxuICAgKiBAcGFyYW0gIHtPYmplY3R9IHJhdyAtIHJhdyBtZXNzYWdlXG4gICAqIEByZXR1cm4gIHtVbmRlZmluZWR9IHVuZGVmaW5lZFxuICAgKi9cbiAgcHJvY2Vzc01lc3NhZ2UocmF3KSB7XG4gICAgLy8gcGF1c2Uga2Fma2EgY29uc3VtZXIgb24gZmlyc3QgbWVzc2FnZVxuICAgIGlmICghdGhpcy5jb25zdW1lci5wYXVzZWQpIHtcbiAgICAgIHRoaXMuZW1pdCgnY29uc3VtZXI6cGF1c2luZycpO1xuICAgICAgdGhpcy5jb25zdW1lci5wYXVzZSgpO1xuICAgIH1cbiAgICAvLyBwYXJzZSBtZXNzYWdlIGFuZCBhZGQgaXQgdG8gcXVldWVcbiAgICBjb25zdCBwYXJzZU1lc3NhZ2UgPSB0aGlzLnBhcnNlID8gdGhpcy5wYXJzZS5iaW5kKHRoaXMpIDogVG9waWNDb25zdW1lci5wYXJzZU1lc3NhZ2U7XG4gICAgcGFyc2VNZXNzYWdlKHJhdylcbiAgICAudGhlbigocGFyc2VkKSA9PiB7XG4gICAgICB0aGlzLnF1ZXVlLnB1c2gocGFyc2VkLCAoZXJyKSA9PiB7XG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICB0aGlzLmVycm9yID0gZXJyO1xuICAgICAgICAgIHRoaXMucXVldWUua2lsbCgpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBRdWV1ZSB3b3JrZXIuIFZhbGlkYXRlIHRoZSBwYXJzZWQgbWVzc2FnZSwgaWdub3JlIGl0IGlmIGludmFsaWQsIG90aGVyd2lzZVxuICAgKiBwYXNzIHRvIGFsbCByZWdpc3RlcmVkIHdvcmtlcnMgYW5kIHBhc3MgaWYgYXQgbGVhc3Qgb25lIHJlc29sdmVzXG4gICAqIEBwYXJhbSAge09iamVjdH0gdGFzayAtIHF1ZXVlIHRhc2tcbiAgICogQHBhcmFtICB7RnVuY3Rpb259IGRvbmUgLSBjYWxsYmFja1xuICAgKiBAcmV0dXJuICB7Qmx1ZWJpcmR9IGJsdWViaXJkXG4gICAqIEBwcml2YXRlXG4gICAqL1xuICBfcHJvY2Vzc1Rhc2sodGFzaywgZG9uZSkge1xuICAgIGNvbnN0IHZhbGlkYXRlID0gdGhpcy52YWxpZGF0ZSB8fCBCbHVlYmlyZC5yZXNvbHZlO1xuICAgIHRoaXMuZW1pdCgnbWVzc2FnZTpwcm9jZXNzaW5nJywgdGFzayk7XG4gICAgcmV0dXJuIHZhbGlkYXRlKHRhc2spXG4gICAgLnJlZmxlY3QoKVxuICAgIC50aGVuKChpbnNwZWN0aW9uKSA9PiB7XG4gICAgICBpZiAoaW5zcGVjdGlvbi5pc1JlamVjdGVkKCkpIHtcbiAgICAgICAgdGhpcy5lbWl0KCdtZXNzYWdlOnNraXBwZWQnLCB0YXNrLCBpbnNwZWN0aW9uLnJlYXNvbigpKTtcbiAgICAgICAgcmV0dXJuIEJsdWViaXJkLnJlc29sdmUoKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHZhbGlkYXRlZCA9IGluc3BlY3Rpb24udmFsdWUoKSB8fCB0YXNrO1xuICAgICAgcmV0dXJuIEJsdWViaXJkLmFsbCh0aGlzLndvcmtlcnMubWFwKHdvcmtlciA9PiB3b3JrZXIodmFsaWRhdGVkKSkpO1xuICAgIH0pXG4gICAgLnRoZW4oKHJlc3VsdHMpID0+IHtcbiAgICAgIHRoaXMuZW1pdCgnbWVzc2FnZTpzdWNjZXNzJywgdGFzaywgcmVzdWx0cyk7XG4gICAgICBkb25lKCk7XG4gICAgfSlcbiAgICAuY2F0Y2goKGVycikgPT4ge1xuICAgICAgdGhpcy5lbWl0KCdtZXNzYWdlOmVycm9yJywgZXJyLCB0YXNrKTtcbiAgICAgIGRvbmUoZXJyKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZWJ1aWxkIHRoZSB1bmRlcmx5aW5nIGNvbnN1bWVyXG4gICAqIEBwYXJhbSAge0Z1bmN0aW9ufSBkb25lIC0gY2FsbGJhY2tcbiAgICogQHJldHVybiAge0JsdWViaXJkfSBibHVlYmlyZFxuICAgKiBAcHJpdmF0ZVxuICAgKi9cbiAgX3JlYnVpbGRDb25zdW1lcihkb25lKSB7XG4gICAgdGhpcy5lbWl0KCdjb25zdW1lcjpyZWJ1aWxkLWluaXRpYXRlZCcpO1xuICAgIGFzeW5jLnNlcmllcyhbXG4gICAgICAvLyBhdHRlbXB0IHRvIGNsb3NlIGV4aXN0aW5nIGNvbnN1bWVyXG4gICAgICAobmV4dCkgPT4ge1xuICAgICAgICBpZiAoIXRoaXMuY29uc3VtZXIpIHtcbiAgICAgICAgICByZXR1cm4gbmV4dCgpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHJldHJ5T3B0aW9ucyA9IGdldCh0aGlzLm9wdGlvbnMsICdyZWJ1aWxkLmNsb3NpbmcnLCB7fSk7XG4gICAgICAgIGRlZmF1bHRzKHJldHJ5T3B0aW9ucywge1xuICAgICAgICAgIHJldHJpZXM6IDIsXG4gICAgICAgICAgbWluVGltZW91dDogbXMoJzMwcycpLFxuICAgICAgICAgIGZhY3RvcjogMixcbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IG9wZXJhdGlvbiA9IHJldHJ5Lm9wZXJhdGlvbihyZXRyeU9wdGlvbnMpO1xuICAgICAgICByZXR1cm4gb3BlcmF0aW9uLmF0dGVtcHQoKCkgPT4ge1xuICAgICAgICAgIHRoaXMuY29uc3VtZXIuY2xvc2UodHJ1ZSwgKGVycikgPT4ge1xuICAgICAgICAgICAgaWYgKG9wZXJhdGlvbi5yZXRyeShlcnIpKSB7XG4gICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgdGhpcy5lbWl0KCdjb25zdW1lcjpjbG9zaW5nLWVycm9yJywgZXJyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG5leHQoKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICB9LFxuXG4gICAgICAvLyBzY2hlZHVsZSBhIHJlYnVpbGQgaW4gdGhlIG5lYXIgZnV0dXJlXG4gICAgICAobmV4dCkgPT4ge1xuICAgICAgICBjb25zdCBkZWxheXMgPSB7XG4gICAgICAgICAgbWluOiBnZXQodGhpcy5vcHRpb25zLCAncmVidWlsZC5taW5EZWxheScpLFxuICAgICAgICAgIG1heDogZ2V0KHRoaXMub3B0aW9ucywgJ3JlYnVpbGQubWF4RGVsYXknKSxcbiAgICAgICAgfTtcbiAgICAgICAgT2JqZWN0LmtleXMoZGVsYXlzKS5mb3JFYWNoKChkZWxheSkgPT4ge1xuICAgICAgICAgIGlmIChpc1N0cmluZyhkZWxheXNbZGVsYXldKSkge1xuICAgICAgICAgICAgZGVsYXlzW2RlbGF5XSA9IG1zKGRlbGF5c1tkZWxheV0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IGRlbGF5ID0gcmFuZG9tKGRlbGF5cy5taW4sIGRlbGF5cy5tYXgpO1xuICAgICAgICB0aGlzLmVtaXQoJ2NvbnN1bWVyOnJlYnVpbGQtc2NoZWR1bGVkJywgZGVsYXkpO1xuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICB0aGlzLmVtaXQoJ2NvbnN1bWVyOnJlYnVpbGQtc3RhcnRlZCcpO1xuICAgICAgICAgIHRoaXMuX2NvbmZpZ3VyZUNvbnN1bWVyKCk7XG4gICAgICAgICAgdGhpcy5jb25uZWN0KG5leHQpO1xuICAgICAgICB9LCBkZWxheSk7XG4gICAgICB9LFxuICAgIF0sIGRvbmUpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlZ2lzdGVyIGEgbmV3IHdvcmtlciBmdW5jdGlvbi4gRWFjaCB3b3JrZXIgZnVuY3Rpb24gc2hvdWxkIGJlIG9mIHRoZSBmb3JtXG4gICAqIChwYXJzZWRWYWx1ZSwgbG9nKSA9PiBCbHVlYmlyZFxuICAgKiBAcGFyYW0gIHtGdW5jdGlvbn0gd29ya2VyIC0gdmFsaWQgd29ya2VyIGZ1bmN0aW9uXG4gICAqIEByZXR1cm4gIHtVbmRlZmluZWR9IHVuZGVmaW5lZFxuICAgKi9cbiAgcmVnaXN0ZXJXb3JrZXIod29ya2VyKSB7XG4gICAgam9pLmFzc2VydCh3b3JrZXIsIGpvaS5mdW5jKDIpLnJlcXVpcmVkKCkpO1xuICAgIHRoaXMud29ya2Vycy5wdXNoKHdvcmtlcik7XG4gIH1cbn1cbiJdfQ==